# 功能计划

- [X]  完成内置的RBAC模块
- [X]  提供部分内置页面: 登录页、错误页(401、403、500)
- [X]  提供默认的用户头像&下拉菜单(个人信息、登出)
- [ ]  提供数据源维护(dbmeta从配置文件获取数据源，改为从数据库中获取数据源)，从而在平台维护下，提供数据源维护模块。以便动态添加数据源
- [ ]  提供数据库自升级功能; 这个需要记录dbmeta版本到数据库中，进行比对，若不一致，则触发执行自升级操作。内置数据目前不允许删除，计划再加强改为不允许删除和编辑，这样，自升级操作就是目前的"系统重置"，确保不会影响用户预期。
- [X]  借助element-ui主题提供2~3个主题换肤;
- [ ]  提供多对多关联数据维护(涉及三张表)的功能模板;
- [ ]  首次启动引导, 提供界面进行初始化配置, 类似于halo那样;
- [X]  FormView的查看页面优化，所有域控件提供查看模式。
- [X]  容器组件中的域排序，默认基于元字段排序，可于容器UI配置时自定义排序。
- [ ]  FormView的打开可以配置是弹窗还是新开tab页面(提供路由/form/toAdd、/form/toUpdate，入参是instanceCode、主键值)
- [ ]  拖拽排序落地，涉及有: 元字段排序、元字段实例配置排序、路由排序、菜单排序、Profile菜单排序、权限模块排序
- [X]  元数据的备份导出，和还原导入。用作元数据备份和跨环境部署。
- [ ]  实现可插拔的外部用户体系、外部RBAC功能集成。以pom依赖的形式插拔。并提供UAC集成的实现。
- [X]  更新主子表的UI, 为：主表点击记录，子表从右侧拉出。
- [ ]  集成大屏设计器。
- [ ]  实现更丰富的元字段配置：增加【参数校验】，支持常见的：必填、长度限制、枚举、数值大小限制和正则等。
- [X]  上传控件(ImgBox和FileBox)本地上传模式下，/api前缀不保留到库中。
- [ ]  将SearchView移除, 过滤功能合并到table中。只展示一个字段的搜索(可切换检索字段)，然后表格中可通过点击表头列来弹框针对指定列的搜索(及排序)，过滤条件加到表头上方(可编辑、启/禁用创建的过滤条件，参考es)
- [ ]  单表增加更丰富的标准功能:
  - [ ] 数据的导入、导出(可选导出字段、文件格式(xlsx、csv)、范围(当前页/指定前几页/全部页))
  - [ ] 查询记录明细(id、和四个审计字段)
  - [ ] 表格行内编辑功能
  - [ ] 增加快速筛选保存功能(保存查询条件，默认内置：今天创建的数据、今天更新的数据)
  - [ ] 文本检索框默认为模糊匹配，将左匹配、右匹配改为值中的简单语法("\*张三", "张三\*")，精确匹配使用“=张三"
- [ ]  字典数据改为单表结构；引入字典类型、父类型，并支持缓存
- [ ]  支持首页定制(个人中心定制首页——其实就是定制有权限的菜单跳转入口作为卡片，以及：默认展示站内消息和使用文档链接)
- [ ]  引入流程引擎flowable和[UI wflow](https://gitee.com/willianfu/jw-workflow-engine)
- [ ]  新增【API客户端】模块，维护客户端公钥、私钥和token有效期、IP白名单等，支持外部系统调用。配套提供token生成的jar包(pom.xml形式)
- [ ]  全局菜单搜索(注意权限过滤)
- [ ]  升级日志系统：链路追踪，对所有请求追加REQUEST-ID
- [ ]  增加业务操作日志
- [ ]  增加【错误码管理】，错误码记录(主表)包含：错误码(唯一)、信息等级；子表包含语言、错误信息(模板)
- [ ]  增加【地区管理】，维护行政区划数据
- [ ]  表单引擎增加辅助控件:  文字、分割线、提示、间距组件
- [ ]  表格类查询增加基于角色、职位的动态SQL控制(引入安全性菜单-跟元对象绑定)
- [ ]  增加消息通知设计，对于通知渠道(站内、短信、邮箱、企微、钉钉)可配置，消息内容可配，通知对象可配，且易自定义，API易用，保留消息通知记录。
  - [ ]  针对短信、企微、钉钉通知，增加配置管理

## 对元对象、功能、实例配置的再思考

- 创建元对象和元字段。
- 创建功能，并创建或关联已经建好的实例配置。比如创建功能:用户管理模块，需要上述三个实例配置，则关联选择(或者直接创建上述三个实例配置)
  > 问题1 那么确定功能的时候就确定了需要哪几个实例配置了，这个信息功能模板需要提供。<br>
  > 问题2 实例配置一定要俱全吗? 比如单表功能模板, 能只选(或创建) user+TableView，其他不要可以吗?
  >
- 创建路由，并关联功能。
- 创建菜单，并关联路由。

-[x] 重新设计创建功能界面
-[x] 调整相关接口, 改为instanceCode是查询容器组件实例配置的唯一依据
-[x] 调整功能模板，改为全部依据featureCode装配整个功能

## 2022/3月 评估多机构支持————单体下玩多租户?

必须能够保留非机构模式！

### 单个数据库, orgId隔离

缺点: 对已有代码侵入比较大。

### 多个数据库, 库隔离

优点: dbMeta天然支持多数据源。
缺点: dbMeta的多数据源支持为的是业务上能够连接多个数据库。如果借助这个特性实现类似多租户的话, 那么单个租户实例就不能支持多数据源了!
业务开发时, 如果用的数据库交互是非activerecord, 比如用mybatis, 那么数据库隔离需要自行做(借助动态数据源, 参考tenant-sdk-db-separate)

首先，dbMeta主机构下添加机构，并初始化机构数据库 ———— 可提供界面操作

- 初始化机构时, 应当可以支持勾选其开通的功能。例如: 勾选指定开通的模块(可能体现为菜单), 其对应的初始化脚本是不一样的。
- 问题是, 该机构用户登录后能使用的模块, 必须能控制在为其开通的那几个指定模块下。因此, 对于机构实例:
- 1. ROOT角色该不该存在? 如果不该存在, 或者即使存在，也不被"特殊对待"(实际实施应当双重保障)的话, 那么即使是我方的实施人员, 也无法利用
     dbMeta的高效特性进行在线升级、调整系统了。 但是如果保留ROOT角色设定, 那么企业用户就可能自我添加ROOT角色，从而绕开功能模块使用限制。
     因此问题的关键在于不允许用户自我绑定ROOT角色。

     【解决思路】: 固定ROOT用户和ROOT角色为系统特殊的用户和角色(后期可通过配置文件配置), 内置的ROOT用户不允许绑定角色, 内置的ROOT角色不允许绑定权限。
     【结论】 ROOT角色依然保留, 且不允许用户添加ROOT角色、或者为用户绑定ROOT角色。但系统对ROOT的"特殊照顾"依旧保留。
- 2. 元数据维护能不能有? 我认为机构初始化脚本里是不能有元数据维护相关模块权限数据的。但是机构实例中ROOT机制保留，使得
     在机构实例中进行元数据维护依然是可行的！

登录入口添加机构选择, 确定用户所连接的机构数据库, 机构标识需要附带到请求header中, 和token一样。

dbMeta后端数据库连接都必须依据机构id, 然后明确选择连接的机构数据库。因此:

- 所有机构数据库连接信息都必须缓存内存中
- 数据源切换操作必须方便快捷

开发思路:

- [ ]  1.新增meta_db表, 将数据源由配置文件改为数据库维护。
- [ ]  2.新增meta_org表, 并关联meta_db, 1:1关系。并提供meta_db和meta_org表的维护界面, 权限配置好。
- [ ]  3.改造DbMeta
  -[ ] 3.1 在认证、鉴权拦截器外围再添加一个机构拦截器, 确定请求所属机构, 并在ThreadLocal维护。
  -[ ] 3.2 所有数据库交互的地方都依据ThreadLocal中的orgId确定交互的数据库
  -[ ] 3.3 提供机构实例初始化逻辑, 并准备初始化脚本。初始化脚本需要根据界面选择开通的功能来生成不同的insert数据！表结构脚本是固定的。ROOT用户和ROOT角色的id都固定0。
  -[ ] 3.4 登录认证改造: 登录界面添加机构选择组件; 所有请求header应当携带orgId(除了登录界面的选择机构接口), 无orgId一律错误
- [ ]  4.提供配置项: 用以确定dbMeta运行实例为 机构模式/单例模式
- [ ]  5.调试
